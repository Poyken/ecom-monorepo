// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ====================================================
// A. MODULE: AUTHENTICATION & RBAC
// ====================================================

model User {
  id          String  @id @default(uuid())
  email       String  @unique
  firstName   String
  lastName    String
  password    String  @db.VarChar(255)
  phoneNumber String? @unique
  isVerified  Boolean @default(false)

  // RBAC relations
  roles       UserRole[]
  permissions UserPermission[]

  // E-commerce relations
  carts     Cart[]
  orders    Order[]
  reviews   Review[]
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Role {
  id   String @id @default(uuid())
  name String @unique

  users       UserRole[]
  permissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id   String @id @default(uuid())
  name String @unique

  roles RolePermission[]
  users UserPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model UserPermission {
  userId       String
  permissionId String

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@index([permissionId])
}

// ====================================================
// B. MODULE: PRODUCT & INVENTORY (SPU / SKU)
// ====================================================

model Category {
  id       String  @id @default(uuid())
  name     String  @unique
  slug     String  @unique
  parentId String?

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
}

model Brand {
  id   String @id @default(uuid())
  name String @unique

  products Product[]
}

model Product {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(255)
  slug        String  @unique @db.VarChar(255)
  description String? @db.Text

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  brandId String
  brand   Brand  @relation(fields: [brandId], references: [id])

  options ProductOption[]
  skus    Sku[]
  reviews Review[]

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, name])
  @@index([slug])
}

model ProductOption {
  id           String @id @default(uuid())
  name         String @db.VarChar(50)
  displayOrder Int?
  productId    String

  product Product       @relation(fields: [productId], references: [id])
  values  OptionValue[]

  @@index([productId])
}

model OptionValue {
  id       String  @id @default(uuid())
  value    String  @db.VarChar(50)
  imageUrl String?
  optionId String

  option      ProductOption      @relation(fields: [optionId], references: [id])
  skuVariants SkuToOptionValue[]

  @@index([optionId])
}

model Sku {
  id        String @id @default(uuid())
  skuCode   String @unique @db.VarChar(50)
  productId String

  price     Decimal? @db.Decimal(10, 2)
  salePrice Decimal? @db.Decimal(10, 2)
  stock     Int      @default(0)
  imageUrl  String?

  status   String @default("INACTIVE")
  metadata Json?

  product      Product            @relation(fields: [productId], references: [id])
  optionValues SkuToOptionValue[]
  cartItems    CartItem[]
  orderItems   OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([skuCode])
}

model SkuToOptionValue {
  skuId         String
  optionValueId String

  sku         Sku         @relation(fields: [skuId], references: [id])
  optionValue OptionValue @relation(fields: [optionValueId], references: [id])

  @@id([skuId, optionValueId])
}

// ====================================================
// C. MODULE: SHOPPING & TRANSACTIONS
// ====================================================

model Address {
  id        String  @id @default(uuid())
  userId    String
  isDefault Boolean @default(false)

  recipientName String
  phoneNumber   String
  street        String
  city          String
  district      String
  ward          String?
  postalCode    String?
  country       String? @db.VarChar(100)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Cart {
  id     String @id @default(uuid())
  userId String @unique

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id       String @id @default(uuid())
  cartId   String
  skuId    String
  quantity Int    @default(1)

  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  sku  Sku  @relation(fields: [skuId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, skuId])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Order {
  id          String      @id @default(uuid())
  userId      String
  status      OrderStatus @default(PENDING)
  totalAmount Decimal     @db.Decimal(10, 2)
  shippingFee Decimal     @default(0.00) @db.Decimal(10, 2)

  // snapshot shipping info
  recipientName   String
  phoneNumber     String
  shippingAddress String @db.Text

  paymentMethod String?
  paymentStatus PaymentStatus @default(UNPAID)
  transactionId String?

  user  User        @relation(fields: [userId], references: [id])
  items OrderItem[]

  orderDate DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([userId, status])
}

model OrderItem {
  id              String  @id @default(uuid())
  orderId         String
  skuId           String
  quantity        Int
  priceAtPurchase Decimal @db.Decimal(10, 2)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sku   Sku   @relation(fields: [skuId], references: [id])

  @@unique([orderId, skuId])
  @@index([skuId])
}

model Review {
  id         String  @id @default(uuid())
  userId     String
  productId  String
  rating     Int     @db.SmallInt
  content    String? @db.Text
  isApproved Boolean @default(false)

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId, rating])
}
